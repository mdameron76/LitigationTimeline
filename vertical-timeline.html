<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Litigation Timeline</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1115; --card:#171a22; --track:#f4a340; --track2:#ffcc80; --accent:#ff824d;
      --text:#eef1f7; --muted:#b6becf; --good:#64d2ff; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(1200px 600px at 80% -100px, #1b2030 0%, transparent 60%), linear-gradient(180deg, #0d1016 0%, #0f1115 100%);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    h1{margin:0 0 14px;font-size:28px;font-weight:800;letter-spacing:.2px}
    .hint{color:var(--muted);font-size:12px;margin-bottom:12px}

    .card{background:var(--card);border:1px solid #23293a;border-radius:18px;padding:18px;box-shadow:var(--shadow)}

    /* --- Vertical timeline --- */
    .timeline{position:relative; min-height:600px; padding:20px 0}
    .track{
      position:absolute; top:0; bottom:0; left:50%; transform:translateX(-50%);
      width:40px; border-radius:999px;
      background:linear-gradient(180deg,var(--track) 0%, var(--track2) 100%);
      box-shadow:inset 0 -2px 0 rgba(0,0,0,.15), 0 6px 20px rgba(0,0,0,.25);
    }
    .ticks{position:absolute; left:50%; transform:translateX(-50%); top:0; bottom:0; width:1px}
    .tick{position:absolute; left:-20px; width:40px; height:1px; background:transparent}
    .tick span{
      position:absolute; left:7px; top:-10px; font-size:8px; color:#ffffff; font-weight:600; 
      text-align:center; width:26px; height:14px; line-height:14px;
      background:rgba(0,0,0,0.4); border-radius:7px; border:1px solid rgba(255,255,255,0.2);
    }

    .items{position:relative}
    .item{
      position:absolute; width:min(42%, 460px);
    }
    .item.left{left:calc(50% - 30px); transform:translateX(-100%);}
    .item.right{left:calc(50% + 30px);}
    .flag{
      background:#1b2030;border:1px solid #2a3144;border-radius:14px;padding:12px;
      box-shadow:0 8px 20px rgba(0,0,0,.35)
    }
    .date{font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.2px}
    .title{margin-top:4px;font-weight:700;line-height:1.35}
    .notes{margin-top:6px;font-size:11px;color:#8892a4;font-style:italic;line-height:1.4}
    .actions{margin-top:8px;display:flex;gap:10px;flex-wrap:wrap}
    .pill{font-size:12px;font-weight:700;padding:6px 8px;border-radius:999px;border:1px solid #2a3144;color:var(--good);cursor:pointer;background:transparent;text-decoration:none}
    .pill:hover{border-color:#3d4761}
    .dot{
      position:absolute; width:12px; height:12px; border-radius:50%; background:#fff; border:3px solid var(--accent);
      box-shadow:0 2px 8px rgba(0,0,0,.4); left:calc(50% - 6px);
    }

    /* Modal */
    dialog#evidenceModal{border:none;border-radius:18px;padding:0;width:min(90vw, 1100px);max-width:1100px;box-shadow:var(--shadow);background:#0c0f16}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #1f2534;background:#141926}
    .modal-header h3{margin:0;font-size:16px;color:var(--good)}
    .modal-body{padding:10px;background:#0c0f16}
    .modal-body img{max-width:100%;height:auto;display:block;border-bottom-left-radius:18px;border-bottom-right-radius:18px}
    .iconbtn{background:#20283a;color:#c9d3ea;border:1px solid #2b3650;border-radius:10px;padding:6px 10px;cursor:pointer;font-weight:700}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 14px;border-top:1px solid #1f2534;background:#0c0f16}

    .empty{color:var(--muted);text-align:center;padding:28px}
    
    /* Event Summary */
    .event-summary{margin-bottom:20px;padding:16px;background:var(--card);border:1px solid #23293a;border-radius:12px}
    .event-summary h3{margin:0 0 12px;font-size:16px;font-weight:600;color:var(--text)}
    .event-tags{display:flex;flex-wrap:wrap;gap:8px}
    .event-tag{display:flex;align-items:center;gap:6px;padding:6px 12px;background:#1a2332;border:1px solid #2a3144;border-radius:20px;font-size:13px;font-weight:500}
    .event-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .timeline{padding:15px 0}
      .track{width:30px}
      .item{width:min(85%, 320px) !important}
      .item.left{left:calc(50% - 25px); transform:translateX(-100%)}
      .item.right{left:calc(50% + 25px)}
      .flag{padding:10px; font-size:14px}
      .title{font-size:15px; line-height:1.3}
      .date{font-size:11px}
      .notes{font-size:10px}
      .actions{margin-top:10px; gap:8px}
      .pill{font-size:11px; padding:5px 7px}
      .tick{left:-15px; width:30px}
      .tick span{left:5px; width:20px; font-size:7px}
      .dot{left:calc(50% - 6px)}
    }

    @media (max-width: 480px) {
      .wrap{padding:0 12px; margin:20px auto}
      h1{font-size:24px}
      .hint{font-size:11px}
      .timeline{padding:10px 0}
      .track{width:25px}
      .item{width:90% !important}
      .item.left{left:calc(50% - 20px); transform:translateX(-100%)}
      .item.right{left:calc(50% + 20px)}
      .flag{padding:8px; border-radius:12px}
      .title{font-size:14px}
      .actions{flex-direction:column; gap:6px}
      .pill{font-size:10px; padding:4px 6px; text-align:center}
      .tick span{font-size:6px; width:18px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Litigation Timeline</h1>
    <div class="hint">Columns required in Google Sheet: <b>Date</b>, <b>Description</b>, <b>EvidenceLink</b>, <b>EventType</b>, <b>Color</b>, <b>Notes</b>.</div>

    <div id="eventSummary" class="event-summary" hidden>
      <h3>Event Summary</h3>
      <div id="eventTags" class="event-tags"></div>
    </div>

    <div class="card">
      <div class="timeline">
        <div class="track"></div>
        <div id="ticks" class="ticks"></div>
        <div id="items" class="items"></div>
      </div>
      <div id="empty" class="empty" hidden>No items found or failed to load.</div>
    </div>
  </div>

  <!-- Evidence modal -->
  <dialog id="evidenceModal" aria-labelledby="evidenceTitle">
    <div class="modal-header">
      <h3 id="evidenceTitle">Evidence</h3>
      <button class="iconbtn" id="closeModal">Close</button>
    </div>
    <div class="modal-body">
      <img id="evidenceImg" alt="Evidence image" style="display:none;" />
      <iframe id="evidenceFrame" style="width:100%;height:600px;border:none;display:none;" allowfullscreen></iframe>
    </div>
    <div class="modal-footer">
      <a id="openInNew" class="iconbtn" target="_blank" rel="noopener">Open in new tab</a>
    </div>
  </dialog>

  <script>
    /* ================= CONFIG =================
       Use API mode (public sheet) OR CSV publish mode.
    =========================================== */
    const CONFIG = {
      mode: 'api', // 'api' | 'csv'
      SHEET_ID: '1fL-jFMsPJGHaM0M-KuT-3FEQ_gpzL8zSenNZWoImcKU',
      API_KEY: 'AIzaSyD-Pld1_Lef3N8bqwU6DVkqkDja73fnY2E',
      RANGE: 'Sheet1!A:F',
      PUBLISHED_CSV_URL: ''   // only if mode === 'csv'
    };

    function toDate(v){
      if(!v) return null;
      if(/^\d{4}-\d{2}-\d{2}/.test(v)) return new Date(v);
      // Excel serial safeguard
      if(/^\d+(\.\d+)?$/.test(v)){
        const serial = parseFloat(v);
        const base = new Date(Date.UTC(1899,11,30));
        base.setUTCDate(base.getUTCDate() + Math.floor(serial));
        return base;
      }
      const d = new Date(v);
      return isNaN(d) ? null : d;
    }

    async function fetchRows(){
      if(CONFIG.mode === 'api'){
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(CONFIG.RANGE)}?key=${CONFIG.API_KEY}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error('Sheets API request failed');
        const data = await r.json();
        const [header, ...rows] = data.values || [];
        if(!header) return [];
        const idx = {
          Date: header.findIndex(h => /date/i.test(h)),
          Description: header.findIndex(h => /desc/i.test(h)),
          EvidenceLink: header.findIndex(h => /evidence/i.test(h)),
          EventType: header.findIndex(h => /event.*type/i.test(h)),
          Color: header.findIndex(h => /color/i.test(h)),
          Notes: header.findIndex(h => /notes/i.test(h))
        };
        return rows.map(r => ({
          Date: r[idx.Date] || '',
          Description: r[idx.Description] || '',
          EvidenceLink: r[idx.EvidenceLink] || '',
          EventType: r[idx.EventType] || '',
          Color: r[idx.Color] || '',
          Notes: r[idx.Notes] || ''
        }));
      } else {
        if(!CONFIG.PUBLISHED_CSV_URL) return [];
        const r = await fetch(CONFIG.PUBLISHED_CSV_URL);
        const text = await r.text();
        const lines = text.split(/\r?\n/).filter(Boolean);
        const header = lines.shift().split(',');
        const idx = {
          Date: header.findIndex(h => /date/i.test(h)),
          Description: header.findIndex(h => /desc/i.test(h)),
          EvidenceLink: header.findIndex(h => /evidence/i.test(h)),
          EventType: header.findIndex(h => /event.*type/i.test(h)),
          Color: header.findIndex(h => /color/i.test(h)),
          Notes: header.findIndex(h => /notes/i.test(h))
        };
        return lines.map(line => {
          const parts = line.split(',');
          return {
            Date: parts[idx.Date] || '',
            Description: parts[idx.Description] || '',
            EvidenceLink: parts[idx.EvidenceLink] || '',
            EventType: parts[idx.EventType] || '',
            Color: parts[idx.Color] || '',
            Notes: parts[idx.Notes] || ''
          };
        });
      }
    }

    function buildEventSummary(items){
      const summaryEl = document.getElementById('eventSummary');
      const tagsEl = document.getElementById('eventTags');
      
      // Count events by type
      const eventCounts = {};
      const eventColors = {};
      
      items.forEach(item => {
        const eventType = item.eventType || 'Unspecified';
        eventCounts[eventType] = (eventCounts[eventType] || 0) + 1;
        if(item.color && !eventColors[eventType]){
          eventColors[eventType] = item.color;
        }
      });
      
      // Clear and rebuild tags
      tagsEl.innerHTML = '';
      
      Object.entries(eventCounts).forEach(([eventType, count]) => {
        const tag = document.createElement('div');
        tag.className = 'event-tag';
        
        const dot = document.createElement('div');
        dot.className = 'event-dot';
        const color = eventColors[eventType];
        dot.style.backgroundColor = (color && /^#[0-9A-Fa-f]{6}$/.test(color)) ? color : '#ff824d';
        
        const text = document.createElement('span');
        text.textContent = `${eventType} - ${count}`;
        
        tag.appendChild(dot);
        tag.appendChild(text);
        tagsEl.appendChild(tag);
      });
      
      summaryEl.hidden = false;
    }

    function buildTimeline(raw){
      const itemsEl = document.getElementById('items');
      const ticksEl = document.getElementById('ticks');
      const empty = document.getElementById('empty');
      const tl = document.querySelector('.timeline');

      itemsEl.innerHTML = '';
      ticksEl.innerHTML = '';

      const items = raw.map(r => ({
        date: toDate(r.Date),
        desc: (r.Description || '').trim(),
        links: (r.EvidenceLink || '').trim().split(',').map(l => l.trim()).filter(l => l),
        eventType: (r.EventType || '').trim(),
        color: (r.Color || '').trim(),
        notes: (r.Notes || '').trim()
      }))
      .filter(x => x.date)
      .sort((a,b) => a.date - b.date);

      if(items.length === 0){ empty.hidden = false; return; }
      empty.hidden = true;

      // --- Build event summary ---
      buildEventSummary(items);

      // --- Determine vertical positions (date-based with anti-overlap) ---
      const min = items[0].date;
      const max = items[items.length - 1].date;
      const span = Math.max(1, (max - min));

      // Base height proportional to item count; min gap in px (responsive)
      const isMobile = window.innerWidth <= 768;
      const minGap = isMobile ? 120 : 90;  // larger gap on mobile to prevent overlap
      let height = Math.max(700, Math.ceil(items.length * minGap * 0.9));

      // First pass: place by date ratio
      let positions = items.map(i => Math.round(((i.date - min) / span) * height));

      // Second pass: enforce minGap and expand height if needed
      for(let i=1;i<positions.length;i++){
        if(positions[i] - positions[i-1] < minGap){
          positions[i] = positions[i-1] + minGap;
        }
      }
      const needed = positions[positions.length-1] + 120;
      if(needed > height) height = needed;
      tl.style.minHeight = height + 'px';

      // --- Monthly ticks down the center line ---
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const startYear = min.getFullYear();
      const startMonth = min.getMonth();
      const endYear = max.getFullYear();
      const endMonth = max.getMonth();
      
      let currentYear = startYear;
      let currentMonth = startMonth;
      
      while(currentYear <= endYear){
        if(currentYear === endYear && currentMonth > endMonth) break;
        
        const monthDate = new Date(currentYear, currentMonth, 1);
        let monthPos = Math.round(((monthDate - min) / span) * height);
        monthPos = Math.max(0, Math.min(height, monthPos));
        
        const tick = document.createElement('div');
        tick.className = 'tick';
        tick.style.top = monthPos + 'px';
        const label = document.createElement('span');
        label.textContent = monthNames[currentMonth];
        tick.appendChild(label);
        ticksEl.appendChild(tick);
        
        currentMonth++;
        if(currentMonth > 11){
          currentMonth = 0;
          currentYear++;
        }
      }

      // --- Render items (alternate left/right) ---
      items.forEach((ev, i) => {
        const top = positions[i];

        const item = document.createElement('div');
        item.className = 'item ' + (i % 2 === 0 ? 'left' : 'right');
        item.style.top = top + 'px';

        const flag = document.createElement('div');
        flag.className = 'flag';
        
        // Apply custom color as left border accent if provided
        if(ev.color && /^#[0-9A-Fa-f]{6}$/.test(ev.color)){
          flag.style.borderLeft = `8px solid ${ev.color}`;
        }

        const d = document.createElement('div');
        d.className = 'date';
        d.textContent = ev.date.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = ev.desc || '(No description)';

        const actions = document.createElement('div');
        actions.className = 'actions';

        // Add notes if they exist
        if(ev.notes){
          const notes = document.createElement('div');
          notes.className = 'notes';
          notes.textContent = ev.notes;
          flag.appendChild(d);
          flag.appendChild(title);
          flag.appendChild(notes);
        } else {
          flag.appendChild(d);
          flag.appendChild(title);
        }

        if(ev.links && ev.links.length > 0){
          ev.links.forEach((link, index) => {
            const a = document.createElement('a');
            a.href = '#';
            a.className = 'pill';
            a.textContent = ev.links.length === 1 ? 'View evidence' : `View evidence ${index + 1}`;
            a.addEventListener('click', e => { e.preventDefault(); openEvidence(link, ev.desc, d.textContent); });
            actions.appendChild(a);
          });
        }

        flag.appendChild(actions);
        item.appendChild(flag);
        itemsEl.appendChild(item);

        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.style.top = (top + 6) + 'px';
        
        // Apply custom color if provided, otherwise use default
        if(ev.color && /^#[0-9A-Fa-f]{6}$/.test(ev.color)){
          dot.style.borderColor = ev.color;
        }
        
        itemsEl.appendChild(dot);
      });
    }

    function openEvidence(url, desc, dateStr){
      const dlg = document.getElementById('evidenceModal');
      const img = document.getElementById('evidenceImg');
      const frame = document.getElementById('evidenceFrame');
      const title = document.getElementById('evidenceTitle');
      const openNew = document.getElementById('openInNew');
      
      // Check if it's a Google Drive link
      const driveMatch = url.match(/drive\.google\.com\/file\/d\/([^\/]+)/);
      if(driveMatch){
        // Use iframe for Google Drive with preview URL
        const previewUrl = `https://drive.google.com/file/d/${driveMatch[1]}/preview`;
        frame.src = previewUrl;
        frame.style.display = 'block';
        img.style.display = 'none';
      } else {
        // Use img tag for direct image URLs
        img.src = url;
        img.style.display = 'block';
        frame.style.display = 'none';
      }
      
      img.alt = desc || 'Evidence';
      title.textContent = `Evidence — ${dateStr}`;
      openNew.href = url;
      if(typeof dlg.showModal === 'function') dlg.showModal();
      else window.open(url, '_blank');
    }
    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('evidenceModal').close();
    });

    (async () => {
      try {
        const rows = await fetchRows();
        buildTimeline(rows);
      } catch (e) {
        console.error(e);
        document.getElementById('empty').hidden = false;
        document.getElementById('empty').textContent = 'Failed to load data. Check config/permissions.';
      }
    })();
  </script>
</body>
</html>
